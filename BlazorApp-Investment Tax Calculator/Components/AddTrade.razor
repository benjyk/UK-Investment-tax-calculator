@using InvestmentTaxCalculator.Model
@using InvestmentTaxCalculator.Model.TaxEvents
@using Syncfusion.Blazor.DropDowns
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.Inputs
@using InvestmentTaxCalculator.ViewModel
@using InvestmentTaxCalculator.Model.Interfaces
@using Syncfusion.Blazor.Buttons
@using InvestmentTaxCalculator.Services
@using InvestmentTaxCalculator.Enumerations
@using CsvHelper
@using CsvHelper.Configuration
@using System.Globalization

@inject IJSRuntime JSRuntime
@inject ITradeAndCorporateActionList tradeList
@inject ToastService toastService
@inject InputGridDatas inputGridDatas

<div class="bg-dark text-light p-4">
    <div class="container-fluid">
        <div class="row mb-5">
            <div class="col text-center">
                <h1 class="display-4">Add Trade</h1>
            </div>
        </div>

        <!-- Instructions and Descriptions Section -->
        <div class="alert alert-info" role="alert">
            <p class="mb-0"><strong>Column Descriptions:</strong></p>
            <ul>
                <li><strong>Asset Name:</strong> The name or title of the asset involved in the trade. Use the ticker symbol if there is one. e.g. GOOG, AAPL</li>
                <li><strong>Date:</strong> The date on which the trade was executed.</li>
                <li><strong>Quantity:</strong> The number of units of the asset traded.</li>
                <li><strong>Acquisition/Disposal:</strong> Indicates whether the trade was an acquisition (buy) or disposal (sell) of the asset.</li>
                <li><strong>Asset Category:</strong> The classification of the asset, future contracts have different calculation rules.</li>
                <li><strong>Gross Proceeds:</strong> This is the amount you paid (for an acquisition)  or received (for a disposal) excluding commission and tax.</li>
                <li><strong>Commission:</strong> The fee charged by the broker or platform for executing the trade.</li>
                <li><strong>Tax Amount:</strong> The total tax levied on the trade.</li>
                <li><strong>Contract Value Amount:</strong> This is for a future contract only. This is the total value of the trade contract in the contract currency.</li>
                <li><strong>Description:</strong> Additional details or notes about the trade.</li>
            </ul>
            <hr>
            <ul>
                <li><strong>Currency:</strong> The 3-letter ISO 4217 code for the currency for the corresponding items.</li>
                <li><strong>Exchange rate:</strong> The exchange rate used to convert the local currency to Sterling for the corresponding items.</li>
            </ul>
        </div>

        <!-- CSV Import Section -->
        <div class="alert alert-secondary mt-4" role="alert">
            <p class="mb-0"><strong>CSV Import:</strong></p>
            <p>Upload a CSV file to bulk import trades. Required columns:</p>
            <code>Asset Name,Date,Quantity,Acquisition/Disposal,Asset Category,Gross Proceeds Currency,Exchange Rate,Gross Proceeds</code>
            <ul class="mt-2">
                <li><strong>Date:</strong> Format: dd-MMM-yyyy (e.g., 19-Jul-2021)</li>
                <li><strong>Acquisition/Disposal:</strong> "Acquisition" or "Disposal"</li>
                <li><strong>Asset Category:</strong> "Stock", "Option", "Future contract", "Foreign currency", or "Bond"</li>
            </ul>
            <div class="mt-3">
                <SfUploader ID="CsvUploader" AutoUpload="false" AllowedExtensions=".csv" Multiple="false">
                    <UploaderEvents ValueChange="OnCsvFileUpload"></UploaderEvents>
                </SfUploader>
            </div>
        </div>

        <div class="control-section mt-4">
            <div class="content-wrapper">
                <div class="row">
                    <SfGrid ID="AddTradeGrid" @ref="_addTradeGrid" DataSource="@inputGridDatas.TradeInputViewModels" Toolbar="@(new List<string> { "Add", "Delete", "Update", "Cancel" })"
                            AllowPaging="true" AllowTextWrap=true>
                        <GridEditSettings AllowAdding="true" AllowDeleting="true" AllowEditing="true" Mode="EditMode.Dialog"></GridEditSettings>
                        <GridEvents OnActionBegin="OnActionBegin" TValue="TradeInputViewModel"></GridEvents>
                        <GridColumns>
                            <GridColumn Field=@nameof(TradeInputViewModel.Id) HeaderText="Id" Visible=false IsPrimaryKey=true></GridColumn>
                            <GridColumn Field=@nameof(TradeInputViewModel.AssetName) HeaderText="Asset Name"></GridColumn>
                            <GridColumn Field=@nameof(TradeInputViewModel.Date) HeaderText="Date" EditType="EditType.DatePickerEdit" Format="d"></GridColumn>
                            <GridColumn Field=@nameof(TradeInputViewModel.Quantity) HeaderText="Quantity" EditType="EditType.NumericEdit"></GridColumn>
                            <GridColumn Field=@nameof(TradeInputViewModel.AcquisitionDisposal) HeaderText="Acquisition/Disposal">
                                <EditTemplate>
                                    @{
                                        <SfDropDownList DataSource="@TradeTypeDropDownEnumValue" @bind-Value="DropDownSelectedTradeType"
                                                        TValue="TradeType" TItem="EnumDescriptionPair<TradeType>" Placeholder="Trade type">
                                            <DropDownListFieldSettings Value="EnumValue" Text="Description"></DropDownListFieldSettings>
                                        </SfDropDownList>
                                    }
                                </EditTemplate>
                            </GridColumn>
                            <GridColumn Field=@nameof(TradeInputViewModel.AssetType) HeaderText="Asset Category">
                                <EditTemplate>
                                @{
                                        <SfDropDownList DataSource="@AssetCatagoryDropDownEnumValue" @bind-Value="DropDownAssetCategoryType"
                                                        TValue="AssetCategoryType" TItem="EnumDescriptionPair<AssetCategoryType>" Placeholder="Asset Category Type">
                                            <DropDownListFieldSettings Value="EnumValue" Text="Description"></DropDownListFieldSettings>
                                        </SfDropDownList>
                                }
                                </EditTemplate>
                            </GridColumn>
                            <GridColumn Field=@nameof(TradeInputViewModel.GrossProceedCurrency) HeaderText="Gross Proceeds Currency"></GridColumn>
                            <GridColumn Field=@nameof(TradeInputViewModel.GrossProceedExchangeRate) HeaderText="Gross Proceeds Exchange Rate" EditType="EditType.NumericEdit"></GridColumn>
                            <GridColumn Field=@nameof(TradeInputViewModel.GrossProceed) HeaderText="Gross Proceeds" EditType="EditType.NumericEdit"></GridColumn>
                            <GridColumn Field=@nameof(TradeInputViewModel.CommissionCurrency) HeaderText="Commission Currency"></GridColumn>
                            <GridColumn Field=@nameof(TradeInputViewModel.CommissionExchangeRate) HeaderText="Commission Exchange Rate" EditType="EditType.NumericEdit"></GridColumn>
                            <GridColumn Field=@nameof(TradeInputViewModel.CommissionAmount) HeaderText="Commission Amount" EditType="EditType.NumericEdit"></GridColumn>
                            <GridColumn Field=@nameof(TradeInputViewModel.TaxCurrency) HeaderText="Tax Currency"></GridColumn>
                            <GridColumn Field=@nameof(TradeInputViewModel.TaxExchangeRate) HeaderText="Tax Exchange Rate" EditType="EditType.NumericEdit"></GridColumn>
                            <GridColumn Field=@nameof(TradeInputViewModel.TaxAmount) HeaderText="Tax Amount" EditType="EditType.NumericEdit"></GridColumn>
                            <GridColumn Field=@nameof(TradeInputViewModel.ContractValueCurrency) HeaderText="Contract Value Currency"></GridColumn>
                            <GridColumn Field=@nameof(TradeInputViewModel.ContractValueExchangeRate) HeaderText="Contract Value Exchange Rate" EditType="EditType.NumericEdit"></GridColumn>
                            <GridColumn Field=@nameof(TradeInputViewModel.ContractValueAmount) HeaderText="Contract Value Amount" EditType="EditType.NumericEdit"></GridColumn>
                            <GridColumn Field=@nameof(TradeInputViewModel.Description) HeaderText="Description"></GridColumn>
                        </GridColumns>
                    </SfGrid>
                    <div class="col-12 mt-3 d-flex justify-content-center">
                        <SfButton OnClick="OnImportTrade">Import trade data</SfButton>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private SfGrid<TradeInputViewModel> _addTradeGrid = new();
    public TradeType DropDownSelectedTradeType { get; set; } = TradeType.ACQUISITION;
    public AssetCategoryType DropDownAssetCategoryType { get; set; } = AssetCategoryType.STOCK;
    public List<EnumDescriptionPair<AssetCategoryType>> AssetCatagoryDropDownEnumValue = [];
    public List<EnumDescriptionPair<TradeType>> TradeTypeDropDownEnumValue = [];

    protected override void OnInitialized()
    {
        TradeTypeDropDownEnumValue = EnumExtensions.GetEnumDescriptionPair<TradeType>(typeof(TradeType));
        AssetCatagoryDropDownEnumValue = EnumExtensions.GetEnumDescriptionPair<AssetCategoryType>(typeof(AssetCategoryType));
    }

    public void OnImportTrade()
    {
        int importCount = inputGridDatas.TradeInputViewModels.Count;
        int optionCount = 0, futureCount = 0, tradeCount = 0;

        foreach (TradeInputViewModel tradeInputViewModel in inputGridDatas.TradeInputViewModels)
        {
            Trade trade = tradeInputViewModel.Convert();

            // Route to correct list based on trade type
            if (trade is OptionTrade optionTrade)
            {
                tradeList.OptionTrades.Add(optionTrade);
                optionCount++;
            }
            else if (trade is FutureContractTrade futureTrade)
            {
                tradeList.FutureContractTrades.Add(futureTrade);
                futureCount++;
            }
            else
            {
                tradeList.Trades.Add(trade);
                tradeCount++;
            }
        }
        inputGridDatas.TradeInputViewModels.Clear();
        _addTradeGrid.Refresh();

        if (importCount >= 1)
        {
            string message = $"{importCount} trade(s) added to system.";
            if (optionCount > 0) message += $" Options: {optionCount}.";
            if (futureCount > 0) message += $" Futures: {futureCount}.";
            if (tradeCount > 0) message += $" Stocks/Other: {tradeCount}.";
            toastService.ShowInformation(message);
        }
        else
        {
            toastService.ShowError($"No trade data added. Table is empty.");
        }
    }

    public void OnActionBegin(ActionEventArgs<TradeInputViewModel> Args)
    {
        if (Args.RequestType == Syncfusion.Blazor.Grids.Action.Save)
        {
            Args.Data.AcquisitionDisposal = DropDownSelectedTradeType;
            Args.Data.AssetType = DropDownAssetCategoryType;
            var inputData = Args.Data;
            foreach(var error in inputData.ValidateError())
            {
                toastService.ShowError(error);
                Args.Cancel = true; // Save is cancelled and the dialog remains open
            }
            foreach (var warning in inputData.ValidateWarning())
            {
                toastService.ShowWarning(warning);
            }
        }
        if (Args.RequestType == Syncfusion.Blazor.Grids.Action.BeginEdit)
        {
            DropDownSelectedTradeType = Args.Data.AcquisitionDisposal;
            DropDownAssetCategoryType = Args.Data.AssetType;
        }
    }

    private async Task OnCsvFileUpload(UploadChangeEventArgs args)
    {
        foreach (var file in args.Files)
        {
            try
            {
                using var stream = file.File.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);
                using var reader = new StreamReader(stream);
                string csvContent = await reader.ReadToEndAsync();
                ParseCsvTrades(csvContent);
                await _addTradeGrid.Refresh();
            }
            catch (Exception ex)
            {
                toastService.ShowException(ex);
            }
        }
        args.Files.Clear();
    }

    private void ParseCsvTrades(string csvContent)
    {
        var config = new CsvConfiguration(CultureInfo.InvariantCulture)
        {
            HeaderValidated = null,
            MissingFieldFound = null
        };

        using var reader = new StringReader(csvContent);
        using var csv = new CsvReader(reader, config);
        csv.Read();
        csv.ReadHeader();

        int rowCount = 0;
        int errorCount = 0;

        while (csv.Read())
        {
            rowCount++;
            try
            {
                var trade = new TradeInputViewModel
                {
                    AssetName = csv.GetField("Asset Name") ?? throw new InvalidDataException($"Row {rowCount}: Asset Name is required"),
                    Date = ParseDate(csv.GetField("Date") ?? throw new InvalidDataException($"Row {rowCount}: Date is required")),
                    Quantity = decimal.Parse(csv.GetField("Quantity") ?? throw new InvalidDataException($"Row {rowCount}: Quantity is required")),
                    AcquisitionDisposal = ParseTradeType(csv.GetField("Acquisition/Disposal") ?? throw new InvalidDataException($"Row {rowCount}: Acquisition/Disposal is required")),
                    AssetType = ParseAssetCategory(csv.GetField("Asset Category") ?? throw new InvalidDataException($"Row {rowCount}: Asset Category is required")),
                    GrossProceedCurrency = csv.GetField("Gross Proceeds Currency") ?? "GBP",
                    GrossProceedExchangeRate = decimal.Parse(csv.GetField("Exchange Rate") ?? "1"),
                    GrossProceed = decimal.Parse(csv.GetField("Gross Proceeds") ?? throw new InvalidDataException($"Row {rowCount}: Gross Proceeds is required"))
                };
                inputGridDatas.TradeInputViewModels.Add(trade);
            }
            catch (Exception ex)
            {
                errorCount++;
                toastService.ShowError($"Row {rowCount}: {ex.Message}");
            }
        }

        if (rowCount - errorCount > 0)
        {
            toastService.ShowInformation($"{rowCount - errorCount} trades loaded from CSV. Click 'Import trade data' to add them to the system.");
        }
    }

    private static DateTime ParseDate(string dateStr)
    {
        // Support multiple date formats
        string[] formats = ["dd-MMM-yyyy", "dd/MM/yyyy", "yyyy-MM-dd", "MM/dd/yyyy", "d-MMM-yyyy"];
        if (DateTime.TryParseExact(dateStr, formats, CultureInfo.InvariantCulture, DateTimeStyles.None, out DateTime result))
        {
            return result;
        }
        if (DateTime.TryParse(dateStr, CultureInfo.InvariantCulture, DateTimeStyles.None, out result))
        {
            return result;
        }
        throw new InvalidDataException($"Unable to parse date '{dateStr}'");
    }

    private static TradeType ParseTradeType(string value)
    {
        return value.ToLowerInvariant() switch
        {
            "acquisition" or "buy" or "acquire" => TradeType.ACQUISITION,
            "disposal" or "sell" or "dispose" => TradeType.DISPOSAL,
            _ => throw new InvalidDataException($"Unknown trade type '{value}'. Use 'Acquisition' or 'Disposal'.")
        };
    }

    private static AssetCategoryType ParseAssetCategory(string value)
    {
        return value.ToLowerInvariant() switch
        {
            "stock" or "equity" or "share" => AssetCategoryType.STOCK,
            "option" or "warrant" => AssetCategoryType.OPTION,
            "future" or "future contract" or "futures" => AssetCategoryType.FUTURE,
            "fx" or "foreign currency" or "forex" => AssetCategoryType.FX,
            "bond" or "bonds" => AssetCategoryType.BOND,
            _ => throw new InvalidDataException($"Unknown asset category '{value}'. Use 'Stock', 'Option', 'Future contract', 'Foreign currency', or 'Bond'.")
        };
    }
}
